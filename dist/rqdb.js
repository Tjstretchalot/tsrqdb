import{createRequire as e}from"module";var t={n:e=>{var o=e&&e.__esModule?()=>e.default:()=>e;return t.d(o,{a:o}),o},d:(e,o)=>{for(var r in o)t.o(o,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:o[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},o={};t.d(o,{kJ:()=>l,vv:()=>n,d6:()=>Q,zb:()=>w,qw:()=>P,qv:()=>O,fV:()=>r,ID:()=>B,CC:()=>i,oZ:()=>s,B3:()=>b,Ft:()=>E,fA:()=>x,sI:()=>u,TZ:()=>h,Bb:()=>d,ke:()=>a});class r extends Error{log;constructor(e){super("All hosts exhausted"),this.log=e}}class n extends Error{constructor(){super("Query canceled")}}class s extends Error{rawError;queryIndex;constructor(e,t,o){super(e),this.rawError=t,this.queryIndex=o}}class i{raw;constructor(e){this.raw=e}get results(){return this.raw.values??void 0}get lastInsertId(){return this.raw.last_insert_id??void 0}get rowsAffected(){return this.raw.rows_affected??void 0}get error(){return this.raw.error??void 0}}const a=e=>{if(null!==e.error&&void 0!==e.error)throw new s(`A SQL error occurred: ${JSON.stringify(e.error)}`,e.error,0)};class l{itemsRaw;adaptedItems;constructor(e){this.itemsRaw=e.results,this.adaptedItems=void 0}get items(){return void 0===this.adaptedItems&&(this.adaptedItems=this.itemsRaw.map((e=>new i(e)))),this.adaptedItems}}const d=e=>{for(let t=0;t<e.itemsRaw.length;t++){const o=e.itemsRaw[t];if(null!==o.error&&void 0!==o.error)throw new s(`A SQL error occurred on query at index ${t}: ${JSON.stringify(o.error)}`,o.error,t)}},h=e=>{if(e.length<1)throw new Error("EXPLAIN query always produces at least one row");if(4!==e[0].length)throw new Error("EXPLAIN query always produces four columns");const t=[],o=new Map;let r=0;for(const n of e){const e=n[0],s=n[3],i=n[1],a={id:e,detail:s,parent:null,children:[]};if(o.set(e,a),r=Math.max(r,e),0===i)t.push(a);else{const e=o.get(i);if(void 0===e)throw new Error(`EXPLAIN query contains row with unknown parent ID ${i}`);a.parent=e,e.children.push(a)}}return{roots:t,largestId:r}},c=(()=>{const e={indent:3,newline:"\n",includeRaw:!1,vbar:"|",dash:e=>"-".repeat(e),colorRaw:e=>e,colorDetail:e=>e};return async function(){try{const t=await import("chalk"),o="gray"in t?t:t.default;if(o&&"gray"in o){e.vbar=o.gray("|"),e.dash=e=>o.gray("-".repeat(e)),e.colorRaw=e=>o.gray(e);const t=[["SCAN",o.redBright],["UNION ALL",o.redBright],["MATERIALIZE",o.redBright],["CORRELATED SCALAR SUBQUERY",o.redBright],["USING COVERING INDEX",o.greenBright],["USING INTEGER PRIMARY KEY",o.greenBright],["USING ROWID SEARCH",o.greenBright],["SEARCH",o.whiteBright],["USING INDEX",o.whiteBright],["USE TEMP B-TREE",o.whiteBright],["USING TEMP B-TREE",o.whiteBright],["SCALAR SUBQUERY",o.whiteBright],["LIST SUBQUERY",o.whiteBright],["MERGE",o.whiteBright]],r=Object.fromEntries(t),n=new RegExp(`\\b(${Object.keys(t).join("|")})\\b`,"g");e.colorDetail=e=>e.replace(n,(e=>r[e](e)))}}catch(e){}}(),e})(),u=(e,t)=>{const o=e.largestId.toString().length,r=Object.assign({},c,t,{formatId:e=>e.toString().padStart(o," ")}),n=[];for(const t of e.roots)f(t,0,n,r);return n.join(r.newline)},f=(e,t,o,r)=>{const n=[];r.includeRaw&&n.push(r.colorRaw(`[id: ${r.formatId(e.id)}, par: ${r.formatId(e.parent?.id??0)}] `)),t>0&&(n.push(" ".repeat(r.indent*t-1)),n.push(r.vbar)),n.push(r.dash(r.indent-1)),n.push(r.colorDetail(e.detail)),o.push(n.join(""));for(const n of e.children)f(n,t+1,o,r)},m=/WITH( RECURSIVE)?\s+(,?\s*\S+(\s?\([^\)]+\))?\s+AS\s+((NOT\s+)?MATERIALIZED\s+)?\(.+?\))+\s+(?<cmd>INSERT|UPDATE|DELETE|SELECT)/is,p=e=>{const t=e.match(/^\s*(\S+)/)?.[1];if(void 0===t)throw new Error("Unable to determine SQL command because the SQL string is empty");const o=t.toUpperCase();if("WITH"===o){const t=e.match(m);if(null===t)throw new Error("Unable to determine SQL command using Common Table Expressions (CTEs) (no match)");const o=t.groups?.cmd;if(void 0===o)throw new Error("Unable to determine SQL command using Common Table Expressions (CTEs) (bad regex)");return o.toUpperCase()}return o},g=async e=>[e,await e.json()];class w{connection;options;constructor(e,t){this.connection=e,this.options=t}async execute(e,t,o){const r=o?.raiseOnError??!0,n=o?.readConsistency??this.options?.readConsistency??this.connection.options.readConsistency,s=o?.freshness??this.options?.freshness??this.connection.options.freshness,l=t??[],d=p(e),h="SELECT"===d||"EXPLAIN"===d,c=Math.random().toString(36).substring(2);let u,f;if(h){const t=this.connection.options.log.readStart;if(t.enabled){let o=e;void 0!==t.maxLength&&o.length>t.maxLength&&(o=o.substring(0,t.maxLength)+"...");let r=JSON.stringify(l);void 0!==t.maxLength&&r.length>t.maxLength&&(r=r.substring(0,t.maxLength)+"...");let i="";"none"===n&&(i=`, freshness="${s}"`);const a=`  [RQLITE ${d} @ ${n}${i} {${c}}] - ${JSON.stringify(o)}; ${r}`,h=this.connection.options.log.meta.format(t.level,a);void 0!==h&&t.method(h)}u=performance.now(),f=this.connection.fetchResponse(n,s,"POST","/db/query?level="+n+("none"===n?"&freshness="+s:"")+("none"!==n?"&redirect":""),JSON.stringify([[e,...l]]),{"Content-Type":"application/json; charset=UTF-8"},o?.signal,g)}else{const t=this.connection.options.log.writeStart;if(t.enabled){let o=e;void 0!==t.maxLength&&o.length>t.maxLength&&(o=o.substring(0,t.maxLength)+"...");let r=JSON.stringify(l);void 0!==t.maxLength&&r.length>t.maxLength&&(r=r.substring(0,t.maxLength)+"...");const n=`  [RQLITE ${d} {${c}}] - ${JSON.stringify(o)}; ${r}`,s=this.connection.options.log.meta.format(t.level,n);void 0!==s&&t.method(s)}u=performance.now(),f=this.connection.fetchResponse("strong",s,"POST","/db/execute?redirect",JSON.stringify([[e,...l]]),{"Content-Type":"application/json; charset=UTF-8"},o?.signal,g)}const[m,w]=await f,v=performance.now()-u,b=h?this.connection.options.log.readResponse:this.connection.options.log.writeResponse;if(b.enabled){let e=JSON.stringify(w);void 0!==b.maxLength&&e.length>b.maxLength&&(e=e.substring(0,b.maxLength)+"...");const t=`    {${c}} in ${(v/1e3).toLocaleString(void 0,{maximumFractionDigits:3})}s via ${m.url} - ${e}`,o=this.connection.options.log.meta.format(b.level,t);void 0!==o&&b.method(o)}if(void 0!==w.error){const r="string"==typeof w.error?w.error:JSON.stringify(w.error);if(h&&"stale read"===r&&"none"===n){const r=this.connection.options.log.readStale;if(r.enabled){const e=`    {${c}} ->> stale read, retrying with weak consistency`,t=this.connection.options.log.meta.format(r.level,e);void 0!==t&&r.method(t)}return await this.execute(e,t,{...o,readConsistency:"weak"})}throw new Error(r)}if(void 0===w.results)throw new Error("No results returned");if(1!==w.results.length)throw new Error("Unexpected number of results returned");const E=w.results[0],y=new i(E);return r&&a(y),y}async executeMany2(e,t,o){const r=o?.raiseOnError??!0,n=t??e.map((()=>[])),s=o?.transaction??!0;if(e.length!==n.length)throw new Error("operations and parameters must be the same length");const i="/db/execute?redirect"+(s?"&transaction":""),a=Math.random().toString(36).substring(2),h=[...e.map(((e,t)=>[e,...n[t]]))],c=this.connection.options.log.writeStart;if(c.enabled){let e=JSON.stringify(h,null,2);void 0!==c.maxLength&&e.length>c.maxLength&&(e=e.substring(0,c.maxLength)+"...");const t=`  [RQLITE BULK {${a}}] - ${e}`,o=this.connection.options.log.meta.format(c.level,t);void 0!==o&&c.method(o)}const u=performance.now(),[f,m]=await this.connection.fetchResponse("strong",this.connection.options.freshness,"POST",i,JSON.stringify(h),{"Content-Type":"application/json; charset=UTF-8"},o?.signal,g),p=performance.now()-u,w=this.connection.options.log.writeResponse;if(w.enabled){let e=JSON.stringify(m);void 0!==w.maxLength&&e.length>w.maxLength&&(e=e.substring(0,w.maxLength)+"...");const t=`    {${a}} in ${(p/1e3).toLocaleString(void 0,{maximumFractionDigits:3})}s via ${f.url} - ${e}`,o=this.connection.options.log.meta.format(w.level,t);void 0!==o&&w.method(o)}if(void 0!==m.error){const e="string"==typeof m.error?m.error:JSON.stringify(m.error);throw new Error(e)}if(void 0===m.results)throw new Error("No results returned");const v=new l({results:m.results});return r&&d(v),v}async executeMany3(e,t){return await this.executeMany2(e.map((([e])=>e)),e.map((([,e])=>e)),t)}async explain(e,t,o){"EXPLAIN"!==p(e)&&(e="EXPLAIN QUERY PLAN "+e);const r=o?.readConsistency??this.options?.readConsistency??this.connection.options.readConsistency,n="strong"===r?"weak":r,s=await this.execute(e,t,{...o,readConsistency:n,raiseOnError:!0});if(void 0===s.results)throw new Error("EXPLAIN query did not return any results");const i=h(s.results);if(o?.out){const e=u(i,o.format);o.out(e)}return i}}const v=e(import.meta.url)("util"),b=(()=>{const e={debug:e=>e,info:e=>e,warning:e=>e,error:e=>e,timestamp:e=>e,errorDetails:e=>e,SELECT:e=>e,INSERT:e=>e,UPDATE:e=>e,DELETE:e=>e,EXPLAIN:e=>e,BULK:e=>e};return async function(){try{const t=await import("chalk"),o="gray"in t?t:t.default;o&&"gray"in o&&(e.debug=o.gray,e.info=o.white,e.warning=o.yellowBright,e.error=o.redBright,e.timestamp=o.green,e.errorDetails=o.gray,e.SELECT=o.cyan,e.INSERT=o.blueBright,e.UPDATE=o.yellow,e.DELETE=o.red,e.EXPLAIN=o.magentaBright,e.BULK=o.whiteBright)}catch(e){}}(),e})(),E=(e,t,o)=>{const r=(new Date).toLocaleString(),n=void 0!==o?`\n${b.errorDetails((0,v.inspect)(o))}`:"";return`${b.timestamp(r)} ${b[e](t)}${n}`},y=e=>console.log(e),S=/(?<cmd>SELECT|INSERT|UPDATE|DELETE|EXPLAIN|BULK)/,R=e=>{const t=e.match(S);if(null!==t){const o=t.groups?.cmd;if(void 0!==o){const t=b[o];void 0!==t&&(e=e.replace(S,t(o)))}}y(e)},x={meta:{format:E},readStart:{method:R,level:"debug",maxLength:void 0,enabled:!0},readResponse:{method:y,level:"debug",maxLength:1024,enabled:!0},readStale:{method:y,level:"debug",maxLength:void 0,enabled:!0},writeStart:{method:R,level:"debug",maxLength:void 0,enabled:!0},writeResponse:{method:y,level:"debug",maxLength:void 0,enabled:!0},followRedirect:{method:y,level:"debug",maxLength:void 0,enabled:!1},fetchError:{method:y,level:"debug",maxLength:void 0,enabled:!0},connectTimeout:{method:y,level:"debug",maxLength:void 0,enabled:!0},readTimeout:{method:y,level:"error",maxLength:void 0,enabled:!0},hostsExhausted:{method:y,level:"error",maxLength:void 0,enabled:!0},nonOkResponse:{method:y,level:"warning",maxLength:void 0,enabled:!0},backupStart:{method:y,level:"info",maxLength:void 0,enabled:!0},backupEnd:{method:y,level:"info",maxLength:void 0,enabled:!0}},L=(e,t,o)=>{if(void 0===t)return;const r=t[o];if(void 0!==r)if(!1!==r){if(!0===r){if(e[o].enabled)return;return x[o].enabled?void(e[o]={...x[o]}):void(e[o]={method:y,level:"debug",maxLength:void 0,enabled:!0})}e[o]={method:r.method??x[o].method,level:r.level??x[o].level,maxLength:r.maxLength,enabled:!0}}else e[o]={method:()=>{},level:"debug",maxLength:0,enabled:!1}},I=e(import.meta.url)("crypto"),T=()=>{const e=(0,I.randomBytes)(8);return e[0]=0,e[1]&=31,Number(e.readBigUInt64BE(0))/Number.MAX_SAFE_INTEGER},N=e=>{if(e<=0)throw new Error("max must be greater than 0");if(1===e)return()=>0;if(e<=256){if(0==(e&e-1)){const t=e-1;return()=>(0,I.randomBytes)(1)[0]&t}const t=256-256%e;if(100*(1-t/256)<5)return()=>{for(;;){const o=(0,I.randomBytes)(1)[0];if(!(o>=t))return o%e}}}return()=>{for(;;){const t=Math.floor(T()*e);if(t!==e)return t}}},$=e=>{if(e<0)throw new Error("length must be at least 0");if(0===e)return()=>[];if(1===e)return()=>[0];if(2===e){const e=N(2);return()=>{const t=e();return[t,1-t]}}if(e<16){const t=[];for(let o=0;o<e;o++)t.push(N(o+1));return()=>{const o=new Array(e);for(let r=0;r<e;r++){const e=t[r]();o[r]=o[e],o[e]=r}return o}}return()=>{const t=new Array(e);for(let o=0;o<e;o++)for(;;){const e=Math.floor(T()*(o+1));e!==o+1&&(t[o]=t[e],t[e]=o)}return t}},k=()=>{const e=N(256);return(t,o)=>new Promise(((r,s)=>{if(o.aborted)return void s(new n);let i,a=!1;const l=()=>{a=!0,void 0!==i&&(clearTimeout(i),i=void 0),o.removeEventListener("abort",d)},d=()=>{a||(l(),s(new n))};o.addEventListener("abort",d),i=setTimeout((()=>{i=void 0,a||(l(),r())}),1e3*2**t+e())}))},A=(e,t)=>{if(1!==e.length)throw new Error("hosts must have length 1");const o=k();return{createNodeSelectorForQuery:(n,s,i)=>{let a=0,l=0;return{selectNode:async()=>{if(a>=t.maxAttemptsPerHost-1)throw new r(!0);return l=0,a++,e[0]},onSuccess:()=>Promise.resolve(),onRedirect:async()=>l>=t.maxRedirects?{log:!0,follow:!1}:(l++,{follow:!0,log:!0}),onFailure:()=>o(a,i)}}}},O=(e,t)=>{if(1===e.length)return A(e,t);const o=B(e,t);return{createNodeSelectorForQuery:(e,t,r,s)=>{if("none"===e)return o.createNodeSelectorForQuery(e,t,r,s);const i=o.createNodeSelectorForQuery(e,t,r,s);let a=null;return{selectNode:async()=>{if(null!==a)return a.selectNode();for(;;){if(r.aborted)throw new n;const e=await i.selectNode();try{const t=await fetch(`${e}/db/query?level=weak&redirect`,{headers:{"Content-Type":"application/json; charset=UTF-8"},body:'[["SELECT 1"]]',signal:r,redirect:"manual"});if(r.aborted)throw await i.onFailure({type:"timeout"}),new n;if(H.includes(t.status)){const e=t.headers.get("Location");if(null===e){await i.onFailure({type:"nonOKResponse",subtype:"status",response:t});continue}const o=(await i.onRedirect({type:"redirect",location:e,response:t})).overrideFollowTarget??e;if(!o.startsWith("http")){await i.onFailure({type:"nonOKResponse",subtype:"body",response:t});continue}const r=o.indexOf("/",8),n=r<0?o:o.slice(0,r);return await i.onSuccess(),n}if(!t.ok){await i.onFailure({type:"nonOKResponse",subtype:"status",response:t});continue}}catch(e){if(r.aborted)throw await i.onFailure({type:"timeout"}),new n;await i.onFailure({type:"fetchError"})}}},onSuccess:async()=>{if(null!==a)return a.onSuccess()},onFailure:async n=>{if(null!==a)return a.onFailure(n);a=o.createNodeSelectorForQuery(e,t,r,s)},onRedirect:async n=>null===a?(a=o.createNodeSelectorForQuery(e,t,r,s),{follow:!1,log:!0}):a.onRedirect(n)}}}};class C{hosts;args;signal;shuffledHosts;nextIndexInShuffledHosts;loopsThroughShuffledHosts;redirects;randomHostIndex;firstPassRandomShuffle;repeatedPassRandomShuffle;backoff;initialIndex;constructor(e,t,o,r,n,s,i){this.hosts=e,this.args=t,this.signal=o,this.shuffledHosts=void 0,this.nextIndexInShuffledHosts=0,this.loopsThroughShuffledHosts=0,this.redirects=0,this.randomHostIndex=r,this.firstPassRandomShuffle=n,this.repeatedPassRandomShuffle=s,this.backoff=i,this.initialIndex=this.randomHostIndex()}async selectNode(){if(this.redirects=0,void 0===this.shuffledHosts){if(0===this.nextIndexInShuffledHosts)return this.nextIndexInShuffledHosts=1,this.hosts[this.initialIndex];const e=this.firstPassRandomShuffle();this.shuffledHosts=new Array(this.hosts.length),this.shuffledHosts[0]=this.hosts[this.initialIndex];for(let t=0;t<this.hosts.length-1;t++){let o=e[t];o>=this.initialIndex&&o++,this.shuffledHosts[t+1]=this.hosts[o]}}if(this.nextIndexInShuffledHosts>=this.shuffledHosts.length){if(this.loopsThroughShuffledHosts>=this.args.maxAttemptsPerHost-1)throw new r(!0);this.loopsThroughShuffledHosts++;const e=this.repeatedPassRandomShuffle();for(let t=0;t<this.hosts.length;t++){let o=e[t];o>=this.initialIndex&&o++,this.shuffledHosts[t]=this.hosts[o]}this.nextIndexInShuffledHosts=0}const e=this.shuffledHosts[this.nextIndexInShuffledHosts];return this.nextIndexInShuffledHosts++,e}async onSuccess(){}async onRedirect(){return this.redirects>=this.args.maxRedirects?{log:!0,follow:!1}:(this.redirects++,{follow:!0,log:!0})}onFailure(){return this.nextIndexInShuffledHosts>=this.hosts.length?this.backoff(this.loopsThroughShuffledHosts,this.signal):Promise.resolve()}}const B=(e,t)=>{if(0===e.length)throw new Error("hosts must not be empty");if(1===e.length)return A(e,t);const o=N(e.length),r=$(e.length-1),n=$(e.length),s=k();return{createNodeSelectorForQuery:(i,a,l,d)=>new C(e,t,l,o,r,n,s)}},P=(e,t)=>{const o=B(e,t);return{createNodeSelectorForQuery:(r,n,s,i)=>i.startsWith("/db/backup")?O(e,t).createNodeSelectorForQuery(r,n,s,i):o.createNodeSelectorForQuery(r,n,s,i)}},F=e(import.meta.url)("fs");var U=t.n(F);const H=[301,302,303,307,308];class Q{hosts;options;selector;constructor(e,t){this.hosts=e;const o=void 0===t?.log?x:(()=>{const e={meta:{...(o=x).meta},readStart:{...o.readStart},readResponse:{...o.readResponse},readStale:{...o.readStale},writeStart:{...o.writeStart},writeResponse:{...o.writeResponse},followRedirect:{...o.followRedirect},fetchError:{...o.fetchError},connectTimeout:{...o.connectTimeout},readTimeout:{...o.readTimeout},hostsExhausted:{...o.hostsExhausted},nonOkResponse:{...o.nonOkResponse},backupStart:{...o.backupStart},backupEnd:{...o.backupEnd}};var o;return((e,t)=>{void 0!==t&&(void 0!==t.meta&&void 0!==t.meta.format&&(e.meta.format=t.meta.format),L(e,t,"readStart"),L(e,t,"readResponse"),L(e,t,"readStale"),L(e,t,"writeStart"),L(e,t,"writeResponse"),L(e,t,"connectTimeout"),L(e,t,"hostsExhausted"),L(e,t,"nonOkResponse"),L(e,t,"backupStart"),L(e,t,"backupEnd"))})(e,t.log),e})();this.options={timeoutMs:5e3,responseTimeoutMs:6e4,maxRedirects:2,maxAttemptsPerHost:2,readConsistency:"weak",freshness:"5m",...t,log:o,nodeSelector:t?.nodeSelector??P},this.selector=this.options.nodeSelector(this.hosts,this.options)}async fetchResponse(e,t,o,s,i,a,l,d,h){if(l?.aborted)throw new n;const c=new AbortController,u=c.signal;let f=!1;const m=[];if(void 0!==l){const e=()=>{f||c.abort()};l.addEventListener("abort",e),m.push((()=>{l.removeEventListener("abort",e)}))}try{const l=this.selector.createNodeSelectorForQuery(e,t,u,s);let h;for(;;){if(u.aborted)throw new n;let e;try{e=h??await l.selectNode()}catch(e){if(e instanceof r&&this.options.log.hostsExhausted.enabled){const t=this.options.log.meta.format(this.options.log.hostsExhausted.level,"All hosts exhausted",e);void 0!==t&&this.options.log.hostsExhausted.method(t,e)}throw e}if(h=void 0,u.aborted)throw new n;const t=new AbortController,c=t.signal;let f,p=!1;const g=()=>{f=void 0,p=!0,t.abort()},w=()=>{void 0!==f&&(clearTimeout(f),f=void 0),t.abort()};let v,b;m.push((()=>{void 0!==f&&(clearTimeout(f),f=void 0),u.removeEventListener("abort",w)})),u.addEventListener("abort",w),f=setTimeout(g,this.options.timeoutMs);let E=!1;try{v=await fetch(`${e}${s}`,{method:o,body:i,headers:a,signal:c,redirect:"manual"}),v.ok&&void 0!==f&&!u.aborted&&(clearTimeout(f),f=setTimeout(g,this.options.responseTimeoutMs),E=!0,b=await d(v,c)),m.pop()()}catch(t){if(u.aborted)throw new n;if(m.pop()(),p){if(E){if(this.options.log.readTimeout.enabled){const o=this.options.log.meta.format(this.options.log.readTimeout.level,`Timeout reading response from ${e}${s}`,t);void 0!==o&&this.options.log.readTimeout.method(o,t)}}else if(this.options.log.connectTimeout.enabled){const o=this.options.log.meta.format(this.options.log.connectTimeout.level,`Timeout fetching from ${e}${s}`,t);void 0!==o&&this.options.log.connectTimeout.method(o,t)}await l.onFailure({type:"timeout"})}else{if(this.options.log.fetchError.enabled){const o=this.options.log.meta.format(this.options.log.fetchError.level,`Error fetching from ${e}${s}`,t);void 0!==o&&this.options.log.fetchError.method(o,t)}await l.onFailure({type:"fetchError"})}continue}if(m.push((()=>{t.abort()})),u.aborted)throw new n;if(H.includes(v.status)){const t=v.headers.get("location");if(null===t){if(this.options.log.nonOkResponse.enabled){const t=this.options.log.meta.format(this.options.log.nonOkResponse.level,`Redirect response missing location header from ${e}${s} despite status code ${v.status}`);void 0!==t&&this.options.log.nonOkResponse.method(t)}await l.onFailure({type:"nonOKResponse",subtype:"body",response:v}),m.pop()();continue}const o=await l.onRedirect({type:"redirect",location:t,response:v});if(u.aborted)throw new n;if(o.follow){h=o.overrideFollowTarget??t;const r=h.indexOf("/",h.startsWith("http")?8:0);if(r>=0&&(h=h.substring(0,r)),this.options.log.followRedirect.enabled){const t=this.options.log.meta.format(this.options.log.followRedirect.level,`Following redirect from ${e}${s} to ${h}`);void 0!==t&&this.options.log.followRedirect.method(t)}}else if(this.options.log.nonOkResponse.enabled){const o=this.options.log.meta.format(this.options.log.nonOkResponse.level,`Exceeded max redirects, last host: ${e}${s}, last location: ${t}`);void 0!==o&&this.options.log.nonOkResponse.method(o)}m.pop()()}else{if(v.ok){if(void 0===b)throw new Error("parseResponse returned undefined, despite not being aborted");return b}if(this.options.log.nonOkResponse.enabled){const t=this.options.log.meta.format(this.options.log.nonOkResponse.level,`Non-OK response from ${e}${s}: ${v.status} ${v.statusText}`);void 0!==t&&this.options.log.nonOkResponse.method(t)}if(await l.onFailure({type:"nonOKResponse",subtype:"status",response:v}),u.aborted)throw new n;m.pop()()}}}finally{f=!0;for(const e of m)e()}}async backup(e,t,o,r,s){const i=r??"weak",a=s??this.options.freshness,l="/db/backup"+("sql"===e?"?fmt=sql":""),d=Math.random().toString(36).substring(2),h=this.options.log.backupStart;if(h.enabled){const t=this.options.log.meta.format(h.level,`  [RQLITE BACKUP {${d}} format=${e}] Starting backup...`);void 0!==t&&h.method(t)}const c=performance.now();await this.fetchResponse(i,a,"GET",l,void 0,void 0,o,(async(e,o)=>{if(o.aborted)throw new n;return await t(e,o),{}}));const u=performance.now(),f=this.options.log.backupEnd;if(f.enabled){const t=(u-c)/1e3,o=this.options.log.meta.format(f.level,`  [RQLITE BACKUP {${d}} format=${e}] Backup complete in ${t.toLocaleString(void 0,{maximumFractionDigits:3})}s`);void 0!==o&&f.method(o)}}backupToFile(e,t,o){return this.backup(e,(async(e,o)=>{if(null===e.body)throw new Error("Response body is null");const r=e.body,s=U().createWriteStream(t);try{let e;try{e=r.getReader({mode:"byob"})}catch(e){}if(void 0!==e){const t=new Uint8Array(16384);for(;;){if(o.aborted)throw new n;const{value:r,done:i}=await e.read(t);if(void 0!==r&&await new Promise(((e,t)=>s.write(r,(o=>{null==o?e():t(o)})))),i)break}}else{const e=r.getReader();for(;;){if(o.aborted)throw new n;const{value:t,done:r}=await e.read();if(void 0!==t&&await new Promise(((e,o)=>s.write(t,(t=>{null==t?e():o(t)})))),r)break}}}finally{s.close()}}),o,"none",void 0)}cursor(e,t){return new w(this,void 0===e&&void 0===t?void 0:{readConsistency:e,freshness:t})}}var D=o.kJ,q=o.vv,M=o.d6,J=o.zb,j=o.qw,K=o.qv,X=o.fV,G=o.ID,W=o.CC,_=o.oZ,Y=o.B3,Z=o.Ft,V=o.fA,z=o.sI,ee=o.TZ,te=o.Bb,oe=o.ke;export{D as RqliteBulkResultAdapter,q as RqliteCanceledError,M as RqliteConnection,J as RqliteCursor,j as RqliteDefaultNodeSelector,K as RqliteExplicitLeaderDiscoveryNodeSelector,X as RqliteHostsExhaustedError,G as RqliteRandomNodeSelector,W as RqliteResultItemAdapter,_ as RqliteSQLError,Y as defaultColors,Z as defaultFormatter,V as defaultLogOptions,z as formatExplainQueryPlan,ee as parseExplainQueryPlan,te as raiseIfAnySQLError,oe as raiseIfSQLError};