import{createRequire as e}from"module";var t={n:e=>{var o=e&&e.__esModule?()=>e.default:()=>e;return t.d(o,{a:o}),o},d:(e,o)=>{for(var s in o)t.o(o,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:o[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},o={};t.d(o,{kJ:()=>l,vv:()=>n,d6:()=>q,zb:()=>w,qw:()=>P,qv:()=>k,fV:()=>s,ID:()=>Q,CC:()=>i,oZ:()=>r,B3:()=>v,Ft:()=>b,fA:()=>R,sI:()=>u,TZ:()=>d,Bb:()=>c,ke:()=>a});class s extends Error{log;constructor(e){super("All hosts exhausted"),this.log=e}}class n extends Error{constructor(){super("Query canceled")}}class r extends Error{rawError;queryIndex;constructor(e,t,o){super(e),this.rawError=t,this.queryIndex=o}}class i{raw;constructor(e){this.raw=e}get results(){return this.raw.values??void 0}get lastInsertId(){return this.raw.last_insert_id??void 0}get rowsAffected(){return this.raw.rows_affected??void 0}get error(){return this.raw.error??void 0}}const a=e=>{if(null!==e.error&&void 0!==e.error)throw new r(`A SQL error occurred: ${JSON.stringify(e.error)}`,e.error,0)};class l{itemsRaw;adaptedItems;constructor(e){this.itemsRaw=e.results,this.adaptedItems=void 0}get items(){return void 0===this.adaptedItems&&(this.adaptedItems=this.itemsRaw.map((e=>new i(e)))),this.adaptedItems}}const c=e=>{for(let t=0;t<e.itemsRaw.length;t++){const o=e.itemsRaw[t];if(null!==o.error&&void 0!==o.error)throw new r(`A SQL error occurred on query at index ${t}: ${JSON.stringify(o.error)}`,o.error,t)}},d=e=>{if(e.length<1)throw new Error("EXPLAIN query always produces at least one row");if(4!==e[0].length)throw new Error("EXPLAIN query always produces four columns");const t=[],o=new Map;let s=0;for(const n of e){const e=n[0],r=n[3],i=n[1],a={id:e,detail:r,parent:null,children:[]};if(o.set(e,a),s=Math.max(s,e),0===i)t.push(a);else{const e=o.get(i);if(void 0===e)throw new Error(`EXPLAIN query contains row with unknown parent ID ${i}`);a.parent=e,e.children.push(a)}}return{roots:t,largestId:s}},h=(()=>{const e={indent:3,newline:"\n",includeRaw:!1,vbar:"|",dash:e=>"-".repeat(e),colorRaw:e=>e,colorDetail:e=>e};return async function(){try{const t=await import("chalk"),o="gray"in t?t:t.default;if(o&&"gray"in o){e.vbar=o.gray("|"),e.dash=e=>o.gray("-".repeat(e)),e.colorRaw=e=>o.gray(e);const t=[["SCAN",o.redBright],["UNION ALL",o.redBright],["MATERIALIZE",o.redBright],["CORRELATED SCALAR SUBQUERY",o.redBright],["USING COVERING INDEX",o.greenBright],["USING INTEGER PRIMARY KEY",o.greenBright],["USING ROWID SEARCH",o.greenBright],["SEARCH",o.whiteBright],["USING INDEX",o.whiteBright],["USE TEMP B-TREE",o.whiteBright],["USING TEMP B-TREE",o.whiteBright],["SCALAR SUBQUERY",o.whiteBright],["LIST SUBQUERY",o.whiteBright],["MERGE",o.whiteBright]],s=Object.fromEntries(t),n=new RegExp(`\\b(${Object.keys(t).join("|")})\\b`,"g");e.colorDetail=e=>e.replace(n,(e=>s[e](e)))}}catch(e){}}(),e})(),u=(e,t)=>{const o=e.largestId.toString().length,s=Object.assign({},h,t,{formatId:e=>e.toString().padStart(o," ")}),n=[];for(const t of e.roots)f(t,0,n,s);return n.join(s.newline)},f=(e,t,o,s)=>{const n=[];s.includeRaw&&n.push(s.colorRaw(`[id: ${s.formatId(e.id)}, par: ${s.formatId(e.parent?.id??0)}] `)),t>0&&(n.push(" ".repeat(s.indent*t-1)),n.push(s.vbar)),n.push(s.dash(s.indent-1)),n.push(s.colorDetail(e.detail)),o.push(n.join(""));for(const n of e.children)f(n,t+1,o,s)},p=/WITH( RECURSIVE)?\s+(,?\s*\S+(\s?\([^\)]+\))?\s+AS\s+((NOT\s+)?MATERIALIZED\s+)?\(.+?\))+\s+(?<cmd>INSERT|UPDATE|DELETE|SELECT)/is,m=e=>{const t=e.match(/^\s*(\S+)/)?.[1];if(void 0===t)throw new Error("Unable to determine SQL command because the SQL string is empty");const o=t.toUpperCase();if("WITH"===o){const t=e.match(p);if(null===t)throw new Error("Unable to determine SQL command using Common Table Expressions (CTEs) (no match)");const o=t.groups?.cmd;if(void 0===o)throw new Error("Unable to determine SQL command using Common Table Expressions (CTEs) (bad regex)");return o.toUpperCase()}return o},g=async e=>[e,await e.json()];class w{connection;options;constructor(e,t){this.connection=e,this.options=t}async execute(e,t,o){const s=o?.raiseOnError??!0,n=o?.readConsistency??this.options?.readConsistency??this.connection.options.readConsistency,r=o?.freshness??this.options?.freshness??this.connection.options.freshness,l=t??[],c=m(e),d="SELECT"===c||"EXPLAIN"===c,h=Math.random().toString(36).substring(2);let u,f;if(d){const t=this.connection.options.log.readStart;if(t.enabled){let o=e;void 0!==t.maxLength&&o.length>t.maxLength&&(o=o.substring(0,t.maxLength)+"...");let s=JSON.stringify(l);void 0!==t.maxLength&&s.length>t.maxLength&&(s=s.substring(0,t.maxLength)+"...");let i="";"none"===n&&(i=`, freshness="${r}"`);const a=`  [RQLITE ${c} @ ${n}${i} {${h}}] - ${JSON.stringify(o)}; ${s}`,d=this.connection.options.log.meta.format(t.level,a);void 0!==d&&t.method(d)}u=performance.now(),f=this.connection.fetchResponse(n,r,"POST","/db/query?level="+n+("none"===n?"&freshness="+r:"")+("none"!==n?"&redirect":""),JSON.stringify([[e,...l]]),{"Content-Type":"application/json; charset=UTF-8"},o?.signal,g,(()=>({operations:[e],params:[l],requestType:"execute-read",consistency:n,freshness:r})))}else{const t=this.connection.options.log.writeStart;if(t.enabled){let o=e;void 0!==t.maxLength&&o.length>t.maxLength&&(o=o.substring(0,t.maxLength)+"...");let s=JSON.stringify(l);void 0!==t.maxLength&&s.length>t.maxLength&&(s=s.substring(0,t.maxLength)+"...");const n=`  [RQLITE ${c} {${h}}] - ${JSON.stringify(o)}; ${s}`,r=this.connection.options.log.meta.format(t.level,n);void 0!==r&&t.method(r)}u=performance.now(),f=this.connection.fetchResponse("strong",r,"POST","/db/execute?redirect",JSON.stringify([[e,...l]]),{"Content-Type":"application/json; charset=UTF-8"},o?.signal,g,(()=>({operations:[e],params:[l],requestType:"execute-write",consistency:"strong",freshness:r})))}const[p,w]=await f,y=performance.now()-u,v=d?this.connection.options.log.readResponse:this.connection.options.log.writeResponse;if(v.enabled){let e=JSON.stringify(w);void 0!==v.maxLength&&e.length>v.maxLength&&(e=e.substring(0,v.maxLength)+"...");const t=`    {${h}} in ${(y/1e3).toLocaleString(void 0,{maximumFractionDigits:3})}s via ${p.url} - ${e}`,o=this.connection.options.log.meta.format(v.level,t);void 0!==o&&v.method(o)}if(void 0!==w.error){const s="string"==typeof w.error?w.error:JSON.stringify(w.error);if(d&&"stale read"===s&&"none"===n){const s=this.connection.options.log.readStale;if(s.enabled){const e=`    {${h}} ->> stale read, retrying with weak consistency`,t=this.connection.options.log.meta.format(s.level,e);void 0!==t&&s.method(t)}return await this.execute(e,t,{...o,readConsistency:"weak"})}throw new Error(s)}if(void 0===w.results)throw new Error("No results returned");if(1!==w.results.length)throw new Error("Unexpected number of results returned");const b=w.results[0],E=new i(b);return s&&a(E),E}async _executeMany2(e,t,o,s,n,r){const i=s?.raiseOnError??!0,a=o??t.map((()=>[])),d=s?.transaction??!0,h=s?.readConsistency??this.options?.readConsistency??this.connection.options.readConsistency,u=s?.freshness??this.options?.freshness??this.connection.options.freshness;if(t.length!==a.length)throw new Error("operations and parameters must be the same length");const f=["redirect"];d&&f.push("transaction"),n&&(f.push("level="+h),"none"===h&&f.push("freshness="+u));const p=e+"?"+f.join("&"),m=Math.random().toString(36).substring(2),w=[...t.map(((e,t)=>[e,...a[t]]))],y=this.connection.options.log.writeStart;if(y.enabled){let e=JSON.stringify(w,null,2);void 0!==y.maxLength&&e.length>y.maxLength&&(e=e.substring(0,y.maxLength)+"...");const t=`  [RQLITE BULK {${m}}] - ${e}`,o=this.connection.options.log.meta.format(y.level,t);void 0!==o&&y.method(o)}const v=performance.now(),[b,E]=await this.connection.fetchResponse("strong",this.connection.options.freshness,"POST",p,JSON.stringify(w),{"Content-Type":"application/json; charset=UTF-8"},s?.signal,g,(()=>r(t,a))),S=performance.now()-v,x=this.connection.options.log.writeResponse;if(x.enabled){let e=JSON.stringify(E);void 0!==x.maxLength&&e.length>x.maxLength&&(e=e.substring(0,x.maxLength)+"...");const t=`    {${m}} in ${(S/1e3).toLocaleString(void 0,{maximumFractionDigits:3})}s via ${b.url} - ${e}`,o=this.connection.options.log.meta.format(x.level,t);void 0!==o&&x.method(o)}if(void 0!==E.error){const e="string"==typeof E.error?E.error:JSON.stringify(E.error);throw new Error(e)}if(void 0===E.results)throw new Error("No results returned");const R=new l({results:E.results});return i&&c(R),R}executeMany2(e,t,o){return this._executeMany2("/db/execute",e,t,o,!1,((e,t)=>({operations:e,params:t,requestType:"executemany",consistency:"strong",freshness:""})))}_executeMany3(e,t,o,s,n){return this._executeMany2(e,t.map((([e])=>e)),t.map((([,e])=>e)),o,s,n)}executeMany3(e,t){return this._executeMany3("/db/execute",e,t,!1,((e,t)=>({operations:e,params:t,requestType:"executemany",consistency:"strong",freshness:""})))}executeUnified2(e,t,o){return this._executeMany2("/db/request",e,t,o,!0,((e,t)=>{const s=e.every((e=>{const t=m(e);return"SELECT"===t||"EXPLAIN"===t}));return{operations:e,params:t,requestType:s?"executeunified-readonly":"executeunified-write",consistency:s?o?.readConsistency??this.options?.readConsistency??this.connection.options.readConsistency:"strong",freshness:s?o?.freshness??this.options?.readConsistency??this.connection.options.freshness:""}}))}executeUnified3(e,t){return this._executeMany3("/db/request",e,t,!0,((e,o)=>{const s=e.every((e=>{const t=m(e);return"SELECT"===t||"EXPLAIN"===t}));return{operations:e,params:o,requestType:s?"executeunified-readonly":"executeunified-write",consistency:s?t?.readConsistency??this.options?.readConsistency??this.connection.options.readConsistency:"strong",freshness:s?t?.freshness??this.options?.readConsistency??this.connection.options.freshness:""}}))}async explain(e,t,o){"EXPLAIN"!==m(e)&&(e="EXPLAIN QUERY PLAN "+e);const s=o?.readConsistency??this.options?.readConsistency??this.connection.options.readConsistency,n="strong"===s?"weak":s,r=await this.execute(e,t,{...o,readConsistency:n,raiseOnError:!0});if(void 0===r.results)throw new Error("EXPLAIN query did not return any results");const i=d(r.results);if(o?.out){const e=u(i,o.format);o.out(e)}return i}}const y=e(import.meta.url)("util"),v=(()=>{const e={debug:e=>e,info:e=>e,warning:e=>e,error:e=>e,timestamp:e=>e,errorDetails:e=>e,SELECT:e=>e,INSERT:e=>e,UPDATE:e=>e,DELETE:e=>e,EXPLAIN:e=>e,BULK:e=>e};return async function(){try{const t=await import("chalk"),o="gray"in t?t:t.default;o&&"gray"in o&&(e.debug=o.gray,e.info=o.white,e.warning=o.yellowBright,e.error=o.redBright,e.timestamp=o.green,e.errorDetails=o.gray,e.SELECT=o.cyan,e.INSERT=o.blueBright,e.UPDATE=o.yellow,e.DELETE=o.red,e.EXPLAIN=o.magentaBright,e.BULK=o.whiteBright)}catch(e){}}(),e})(),b=(e,t,o)=>{const s=(new Date).toLocaleString(),n=void 0!==o?`\n${v.errorDetails((0,y.inspect)(o))}`:"";return`${v.timestamp(s)} ${v[e](t)}${n}`},E=e=>console.log(e),S=/(?<cmd>SELECT|INSERT|UPDATE|DELETE|EXPLAIN|BULK)/,x=e=>{const t=e.match(S);if(null!==t){const o=t.groups?.cmd;if(void 0!==o){const t=v[o];void 0!==t&&(e=e.replace(S,t(o)))}}E(e)},R={meta:{format:b},readStart:{method:x,level:"debug",maxLength:void 0,enabled:!0},readResponse:{method:E,level:"debug",maxLength:1024,enabled:!0},readStale:{method:E,level:"debug",maxLength:void 0,enabled:!0},writeStart:{method:x,level:"debug",maxLength:void 0,enabled:!0},writeResponse:{method:E,level:"debug",maxLength:void 0,enabled:!0},followRedirect:{method:E,level:"debug",maxLength:void 0,enabled:!1},fetchError:{method:E,level:"debug",maxLength:void 0,enabled:!0},connectTimeout:{method:E,level:"debug",maxLength:void 0,enabled:!0},readTimeout:{method:E,level:"error",maxLength:void 0,enabled:!0},hostsExhausted:{method:E,level:"error",maxLength:void 0,enabled:!0},nonOkResponse:{method:E,level:"warning",maxLength:void 0,enabled:!0},slowQuery:{enabled:!1},backupStart:{method:E,level:"info",maxLength:void 0,enabled:!0},backupEnd:{method:E,level:"info",maxLength:void 0,enabled:!0}},L=(e,t,o)=>{if(void 0===t)return;if("slowQuery"===o)return void 0===t.slowQuery?void(e.slowQuery={...R.slowQuery}):void(e.slowQuery={...t.slowQuery});const s=t[o];if(void 0!==s)if(!1!==s){if(!0===s){if(e[o].enabled)return;return R[o].enabled?void(e[o]={...R[o]}):void(e[o]={method:E,level:"debug",maxLength:void 0,enabled:!0})}e[o]={method:s.method??R[o].method,level:s.level??R[o].level,maxLength:s.maxLength,enabled:!0}}else e[o]={method:()=>{},level:"debug",maxLength:0,enabled:!1}},T=e(import.meta.url)("crypto"),I=()=>{const e=(0,T.randomBytes)(8);return e[0]=0,e[1]&=31,Number(e.readBigUInt64BE(0))/Number.MAX_SAFE_INTEGER},N=e=>{if(e<=0)throw new Error("max must be greater than 0");if(1===e)return()=>0;if(e<=256){if(0==(e&e-1)){const t=e-1;return()=>(0,T.randomBytes)(1)[0]&t}const t=256-256%e;if(100*(1-t/256)<5)return()=>{for(;;){const o=(0,T.randomBytes)(1)[0];if(!(o>=t))return o%e}}}return()=>{for(;;){const t=Math.floor(I()*e);if(t!==e)return t}}},$=e=>{if(e<0)throw new Error("length must be at least 0");if(0===e)return()=>[];if(1===e)return()=>[0];if(2===e){const e=N(2);return()=>{const t=e();return[t,1-t]}}if(e<16){const t=[];for(let o=0;o<e;o++)t.push(N(o+1));return()=>{const o=new Array(e);for(let s=0;s<e;s++){const e=t[s]();o[s]=o[e],o[e]=s}return o}}return()=>{const t=new Array(e);for(let o=0;o<e;o++)for(;;){const e=Math.floor(I()*(o+1));e!==o+1&&(t[o]=t[e],t[e]=o)}return t}},C=()=>{const e=N(256);return(t,o)=>new Promise(((s,r)=>{if(o.aborted)return void r(new n);let i,a=!1;const l=()=>{a=!0,void 0!==i&&(clearTimeout(i),i=void 0),o.removeEventListener("abort",c)},c=()=>{a||(l(),r(new n))};o.addEventListener("abort",c),i=setTimeout((()=>{i=void 0,a||(l(),s())}),1e3*2**t+e())}))},A=(e,t)=>{if(1!==e.length)throw new Error("hosts must have length 1");const o=C();return{createNodeSelectorForQuery:(n,r,i)=>{let a=0,l=0;return{selectNode:async()=>{if(a>=t.maxAttemptsPerHost-1)throw new s(!0);return l=0,a++,e[0]},onSuccess:()=>Promise.resolve(),onRedirect:async()=>l>=t.maxRedirects?{log:!0,follow:!1}:(l++,{follow:!0,log:!0}),onFailure:()=>o(a,i)}}}},k=(e,t)=>{if(1===e.length)return A(e,t);const o=Q(e,t);return{createNodeSelectorForQuery:(e,t,s,r)=>{if("none"===e)return o.createNodeSelectorForQuery(e,t,s,r);const i=o.createNodeSelectorForQuery(e,t,s,r);let a=null;return{selectNode:async()=>{if(null!==a)return a.selectNode();for(;;){if(s.aborted)throw new n;const e=await i.selectNode();try{const t=await fetch(`${e}/db/query?level=weak&redirect`,{headers:{"Content-Type":"application/json; charset=UTF-8"},body:'[["SELECT 1"]]',signal:s,redirect:"manual"});if(s.aborted)throw await i.onFailure({type:"timeout"}),new n;if(U.includes(t.status)){const e=t.headers.get("Location");if(null===e){await i.onFailure({type:"nonOKResponse",subtype:"status",response:t});continue}const o=(await i.onRedirect({type:"redirect",location:e,response:t})).overrideFollowTarget??e;if(!o.startsWith("http")){await i.onFailure({type:"nonOKResponse",subtype:"body",response:t});continue}const s=o.indexOf("/",8),n=s<0?o:o.slice(0,s);return await i.onSuccess(),n}if(!t.ok){await i.onFailure({type:"nonOKResponse",subtype:"status",response:t});continue}}catch(e){if(s.aborted)throw await i.onFailure({type:"timeout"}),new n;await i.onFailure({type:"fetchError"})}}},onSuccess:async()=>{if(null!==a)return a.onSuccess()},onFailure:async n=>{if(null!==a)return a.onFailure(n);a=o.createNodeSelectorForQuery(e,t,s,r)},onRedirect:async n=>null===a?(a=o.createNodeSelectorForQuery(e,t,s,r),{follow:!1,log:!0}):a.onRedirect(n)}}}};class O{hosts;args;signal;shuffledHosts;nextIndexInShuffledHosts;loopsThroughShuffledHosts;redirects;randomHostIndex;firstPassRandomShuffle;repeatedPassRandomShuffle;backoff;initialIndex;constructor(e,t,o,s,n,r,i){this.hosts=e,this.args=t,this.signal=o,this.shuffledHosts=void 0,this.nextIndexInShuffledHosts=0,this.loopsThroughShuffledHosts=0,this.redirects=0,this.randomHostIndex=s,this.firstPassRandomShuffle=n,this.repeatedPassRandomShuffle=r,this.backoff=i,this.initialIndex=this.randomHostIndex()}async selectNode(){if(this.redirects=0,void 0===this.shuffledHosts){if(0===this.nextIndexInShuffledHosts)return this.nextIndexInShuffledHosts=1,this.hosts[this.initialIndex];const e=this.firstPassRandomShuffle();this.shuffledHosts=new Array(this.hosts.length),this.shuffledHosts[0]=this.hosts[this.initialIndex];for(let t=0;t<this.hosts.length-1;t++){let o=e[t];o>=this.initialIndex&&o++,this.shuffledHosts[t+1]=this.hosts[o]}}if(this.nextIndexInShuffledHosts>=this.shuffledHosts.length){if(this.loopsThroughShuffledHosts>=this.args.maxAttemptsPerHost-1)throw new s(!0);this.loopsThroughShuffledHosts++;const e=this.repeatedPassRandomShuffle();for(let t=0;t<this.hosts.length;t++){let o=e[t];o>=this.initialIndex&&o++,this.shuffledHosts[t]=this.hosts[o]}this.nextIndexInShuffledHosts=0}const e=this.shuffledHosts[this.nextIndexInShuffledHosts];return this.nextIndexInShuffledHosts++,e}async onSuccess(){}async onRedirect(){return this.redirects>=this.args.maxRedirects?{log:!0,follow:!1}:(this.redirects++,{follow:!0,log:!0})}onFailure(){return this.nextIndexInShuffledHosts>=this.hosts.length?this.backoff(this.loopsThroughShuffledHosts,this.signal):Promise.resolve()}}const Q=(e,t)=>{if(0===e.length)throw new Error("hosts must not be empty");if(1===e.length)return A(e,t);const o=N(e.length),s=$(e.length-1),n=$(e.length),r=C();return{createNodeSelectorForQuery:(i,a,l,c)=>new O(e,t,l,o,s,n,r)}},P=(e,t)=>{const o=Q(e,t);return{createNodeSelectorForQuery:(s,n,r,i)=>i.startsWith("/db/backup")?k(e,t).createNodeSelectorForQuery(s,n,r,i):o.createNodeSelectorForQuery(s,n,r,i)}},B=e(import.meta.url)("fs");var F=t.n(B);const U=[301,302,303,307,308];class q{hosts;options;selector;constructor(e,t){this.hosts=e;const o=void 0===t?.log?R:(()=>{const e={meta:{...(o=R).meta},readStart:{...o.readStart},readResponse:{...o.readResponse},readStale:{...o.readStale},writeStart:{...o.writeStart},writeResponse:{...o.writeResponse},followRedirect:{...o.followRedirect},fetchError:{...o.fetchError},connectTimeout:{...o.connectTimeout},readTimeout:{...o.readTimeout},hostsExhausted:{...o.hostsExhausted},nonOkResponse:{...o.nonOkResponse},slowQuery:{...o.slowQuery},backupStart:{...o.backupStart},backupEnd:{...o.backupEnd}};var o;return((e,t)=>{void 0!==t&&(void 0!==t.meta&&void 0!==t.meta.format&&(e.meta.format=t.meta.format),L(e,t,"readStart"),L(e,t,"readResponse"),L(e,t,"readStale"),L(e,t,"writeStart"),L(e,t,"writeResponse"),L(e,t,"connectTimeout"),L(e,t,"hostsExhausted"),L(e,t,"nonOkResponse"),L(e,t,"slowQuery"),L(e,t,"backupStart"),L(e,t,"backupEnd"))})(e,t.log),e})();this.options={timeoutMs:5e3,responseTimeoutMs:6e4,maxRedirects:2,maxAttemptsPerHost:2,readConsistency:"weak",freshness:"5m",...t,log:o,nodeSelector:t?.nodeSelector??P},this.selector=this.options.nodeSelector(this.hosts,this.options)}async fetchResponse(e,t,o,r,i,a,l,c,d){if(l?.aborted)throw new n;const h=new AbortController,u=h.signal;let f=!1;const p=[];if(void 0!==l){const e=()=>{f||h.abort()};l.addEventListener("abort",e),p.push((()=>{l.removeEventListener("abort",e)}))}try{const l=this.selector.createNodeSelectorForQuery(e,t,u,r);let h;for(;;){if(u.aborted)throw new n;let e;try{e=h??await l.selectNode()}catch(e){if(e instanceof s&&this.options.log.hostsExhausted.enabled){const t=this.options.log.meta.format(this.options.log.hostsExhausted.level,"All hosts exhausted",e);void 0!==t&&this.options.log.hostsExhausted.method(t,e)}throw e}if(h=void 0,u.aborted)throw new n;const t=new AbortController,f=t.signal;let m,g=!1;const w=()=>{m=void 0,g=!0,t.abort()},y=()=>{void 0!==m&&(clearTimeout(m),m=void 0),t.abort()};let v,b;p.push((()=>{void 0!==m&&(clearTimeout(m),m=void 0),u.removeEventListener("abort",y)})),u.addEventListener("abort",y),m=setTimeout(w,this.options.timeoutMs);let E=!1;const S=Date.now(),x=performance.now();try{v=await fetch(`${e}${r}`,{method:o,body:i,headers:a,signal:f,redirect:"manual"}),v.ok&&void 0!==m&&!u.aborted&&(clearTimeout(m),m=setTimeout(w,this.options.responseTimeoutMs),E=!0,b=await c(v,f)),p.pop()()}catch(t){if(u.aborted)throw new n;if(p.pop()(),g){if(E){if(this.options.log.readTimeout.enabled){const o=this.options.log.meta.format(this.options.log.readTimeout.level,`Timeout reading response from ${e}${r}`,t);void 0!==o&&this.options.log.readTimeout.method(o,t)}}else if(this.options.log.connectTimeout.enabled){const o=this.options.log.meta.format(this.options.log.connectTimeout.level,`Timeout fetching from ${e}${r}`,t);void 0!==o&&this.options.log.connectTimeout.method(o,t)}await l.onFailure({type:"timeout"})}else{if(this.options.log.fetchError.enabled){const o=this.options.log.meta.format(this.options.log.fetchError.level,`Error fetching from ${e}${r}`,t);void 0!==o&&this.options.log.fetchError.method(o,t)}await l.onFailure({type:"fetchError"})}continue}if(p.push((()=>{t.abort()})),u.aborted)throw new n;if(U.includes(v.status)){const t=v.headers.get("location");if(null===t){if(this.options.log.nonOkResponse.enabled){const t=this.options.log.meta.format(this.options.log.nonOkResponse.level,`Redirect response missing location header from ${e}${r} despite status code ${v.status}`);void 0!==t&&this.options.log.nonOkResponse.method(t)}await l.onFailure({type:"nonOKResponse",subtype:"body",response:v}),p.pop()();continue}const o=await l.onRedirect({type:"redirect",location:t,response:v});if(u.aborted)throw new n;if(o.follow){h=o.overrideFollowTarget??t;const s=h.indexOf("/",h.startsWith("http")?8:0);if(s>=0&&(h=h.substring(0,s)),this.options.log.followRedirect.enabled){const t=this.options.log.meta.format(this.options.log.followRedirect.level,`Following redirect from ${e}${r} to ${h}`);void 0!==t&&this.options.log.followRedirect.method(t)}}else if(this.options.log.nonOkResponse.enabled){const o=this.options.log.meta.format(this.options.log.nonOkResponse.level,`Exceeded max redirects, last host: ${e}${r}, last location: ${t}`);void 0!==o&&this.options.log.nonOkResponse.method(o)}p.pop()();continue}if(!v.ok){if(this.options.log.nonOkResponse.enabled){const t=this.options.log.meta.format(this.options.log.nonOkResponse.level,`Non-OK response from ${e}${r}: ${v.status} ${v.statusText}`);void 0!==t&&this.options.log.nonOkResponse.method(t)}if(await l.onFailure({type:"nonOKResponse",subtype:"status",response:v}),u.aborted)throw new n;p.pop()();continue}if(void 0===b)throw new Error("parseResponse returned undefined, despite not being aborted");const R=performance.now()-x,L=Date.now();if(null!==d&&this.options.log.slowQuery.enabled&&R>=1e3*this.options.log.slowQuery.thresholdSeconds){const t=d();let o=0;try{o=parseInt(v.headers.get("content-length")??"0")}catch(e){}this.options.log.slowQuery.method(t,{durationSeconds:R/1e3,host:e,responseSizeBytes:o,startedAt:new Date(S),endedAt:new Date(L)})}return b}}finally{f=!0;for(const e of p)e()}}async backup(e,t,o,s,r){const i=s??"weak",a=r??this.options.freshness,l="/db/backup"+("sql"===e?"?fmt=sql":""),c=Math.random().toString(36).substring(2),d=this.options.log.backupStart;if(d.enabled){const t=this.options.log.meta.format(d.level,`  [RQLITE BACKUP {${c}} format=${e}] Starting backup...`);void 0!==t&&d.method(t)}const h=performance.now();await this.fetchResponse(i,a,"GET",l,void 0,void 0,o,(async(e,o)=>{if(o.aborted)throw new n;return await t(e,o),{}}),null);const u=performance.now(),f=this.options.log.backupEnd;if(f.enabled){const t=(u-h)/1e3,o=this.options.log.meta.format(f.level,`  [RQLITE BACKUP {${c}} format=${e}] Backup complete in ${t.toLocaleString(void 0,{maximumFractionDigits:3})}s`);void 0!==o&&f.method(o)}}backupToFile(e,t,o){return this.backup(e,(async(e,o)=>{if(null===e.body)throw new Error("Response body is null");const s=e.body,r=F().createWriteStream(t);try{let e;try{e=s.getReader({mode:"byob"})}catch(e){}if(void 0!==e){const t=new Uint8Array(16384);for(;;){if(o.aborted)throw new n;const{value:s,done:i}=await e.read(t);if(void 0!==s&&await new Promise(((e,t)=>r.write(s,(o=>{null==o?e():t(o)})))),i)break}}else{const e=s.getReader();for(;;){if(o.aborted)throw new n;const{value:t,done:s}=await e.read();if(void 0!==t&&await new Promise(((e,o)=>r.write(t,(t=>{null==t?e():o(t)})))),s)break}}}finally{r.close()}}),o,"none",void 0)}cursor(e,t){return new w(this,void 0===e&&void 0===t?void 0:{readConsistency:e,freshness:t})}}var H=o.kJ,D=o.vv,M=o.d6,J=o.zb,X=o.qw,j=o.qv,_=o.fV,K=o.ID,G=o.CC,W=o.oZ,Y=o.B3,Z=o.Ft,V=o.fA,z=o.sI,ee=o.TZ,te=o.Bb,oe=o.ke;export{H as RqliteBulkResultAdapter,D as RqliteCanceledError,M as RqliteConnection,J as RqliteCursor,X as RqliteDefaultNodeSelector,j as RqliteExplicitLeaderDiscoveryNodeSelector,_ as RqliteHostsExhaustedError,K as RqliteRandomNodeSelector,G as RqliteResultItemAdapter,W as RqliteSQLError,Y as defaultColors,Z as defaultFormatter,V as defaultLogOptions,z as formatExplainQueryPlan,ee as parseExplainQueryPlan,te as raiseIfAnySQLError,oe as raiseIfSQLError};